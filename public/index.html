<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hacker Terminal — STASI</title>

  <!-- three.js CDN (r128) + fallback loader built-in below -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <style>
    /* Minimal, take-what-you-need styling matching previous look */
    :root{--green:#00ff66;--bg:#000000}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--green);font-family:'VT323',monospace;overflow:hidden}
    #loader{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:60}
    #loading-text{font-size:36px;color:var(--green);text-shadow:0 0 10px rgba(0,255,102,0.25)}
    #loading-log{position:fixed;left:16px;bottom:16px;width:420px;height:180px;background:rgba(0,0,0,0.6);border:1px solid var(--green);padding:12px;overflow:auto;color:#bfffcf;font-size:12px;display:block}
    #progress-bar-container{width:60%;height:6px;background:rgba(255,255,255,0.03);margin-top:18px;border-radius:4px;overflow:hidden}
    #progress-bar-fill{height:100%;width:0;background:linear-gradient(90deg,#00ff66,#00a08a);transition:width .4s}
    #access-granted{font-size:20px;color:var(--green);margin-top:12px;display:none}
    #sphere-container{position:fixed;inset:0;z-index:10;pointer-events:none}
    #login-screen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:80}
    .login-box{background:rgba(0,0,0,0.85);border:2px solid var(--green);padding:24px;border-radius:8px;min-width:340px;color:var(--green)}
    label{display:block;font-size:13px;margin-bottom:6px}
    input{width:100%;padding:8px;border-radius:4px;border:1px solid rgba(0,255,102,0.15);background:#061106;color:var(--green);font-family:inherit}
    .hacker-btn{background:transparent;border:1px solid var(--green);color:var(--green);padding:8px 12px;margin-right:8px;border-radius:6px;cursor:pointer}
    .hacker-btn.primary{background:var(--green);color:#002b00}
    #desktop{position:fixed;inset:0;display:none;z-index:50}
    .desktop-icon{position:absolute;left:20px;top:20px;width:88px;height:88px;border:1px dashed rgba(0,255,102,0.12);display:flex;align-items:center;justify-content:center;color:var(--green);border-radius:8px;cursor:pointer}
    .desktop-icon + .desktop-icon{top:120px}
    .icon-label{display:block;text-align:center;font-size:12px;margin-top:8px}
    /* Debug overlay style (small) */
    #debug-overlay{position:fixed;right:12px;bottom:12px;width:420px;max-height:48vh;overflow:auto;background:rgba(0,0,0,0.9);color:#fff;border:1px solid #ff4444;padding:8px;z-index:99999;font-family:monospace;font-size:12px}
  </style>
</head>
<body>
  <!-- Loader / Boot -->
  <div id="loader" role="dialog" aria-hidden="false">
    <div id="sphere-container" aria-hidden="true"></div>
    <div id="loading-text">Starte System...</div>
    <div id="progress-bar-container" aria-hidden="true"><div id="progress-bar-fill"></div></div>
    <div id="access-granted">SYSTEM ONLINE</div>
    <div id="loading-log" aria-hidden="false"></div>
  </div>

  <!-- Login screen -->
  <div id="login-screen">
    <div class="login-box">
      <h2>AUTHENTIFIZIERUNG</h2>
      <div style="margin-bottom:10px">
        <label for="username">Benutzername</label>
        <input id="username" autocomplete="username" />
      </div>
      <div style="margin-bottom:12px">
        <label for="password">Passwort</label>
        <input id="password" type="password" autocomplete="current-password" />
      </div>
      <div style="display:flex;align-items:center">
        <button id="login-btn" class="hacker-btn">LOGIN</button>
        <button id="register-btn" class="hacker-btn primary">REGISTRIEREN</button>
      </div>
      <p id="login-message" style="margin-top:10px;color:#ff6666"></p>
    </div>
  </div>

  <!-- Desktop (icons placeholders) -->
  <div id="desktop">
    <div class="desktop-icon" id="console-icon" style="left:20px;top:20px"><div class="icon-label">Konsole</div></div>
    <div class="desktop-icon" id="chess-icon" style="left:20px;top:120px"><div class="icon-label">Schach</div></div>
    <div class="desktop-icon" id="replay-icon" style="left:20px;top:220px"><div class="icon-label">Replays</div></div>
    <div class="desktop-icon" id="logout-icon" style="left:20px;top:320px"><div class="icon-label">Logout</div></div>
  </div>

  <!-- Debug overlay (hidden if unused) -->
  <div id="debug-overlay" style="display:none"></div>

  <!-- App script (all in one file for reliability) -->
  <script>
  /*************************************************************************
   * Robust, self-contained frontend:
   * - loads three.js from CDN if missing (we already loaded in head)
   * - sets up 3D init and animate as safe functions
   * - boot sequence -> show login (auto-check /api/me)
   * - login/register via /api endpoints (credentials included)
   * - debug overlay to show errors
   *************************************************************************/

  (function () {
    // --------- Config ----------
    const API_BASE = ''; // relative; when hosted on same origin (recommended)
    const loadingLogEl = document.getElementById('loading-log');
    const progressFill = document.getElementById('progress-bar-fill');

    function log(msg) {
      try {
        const p = document.createElement('div');
        p.textContent = '» ' + msg;
        loadingLogEl.appendChild(p);
        loadingLogEl.scrollTop = loadingLogEl.scrollHeight;
      } catch (e) {
        console.log('LOG ERR', e);
      }
    }

    // --------- API helpers ----------
    async function registerToServer(username, password) {
      const res = await fetch(`${API_BASE}/api/register`, {
        method: 'POST',
        credentials: 'include',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ username, password })
      });
      if (!res.ok) throw await res.json();
      return await res.json();
    }
    async function loginToServer(username, password) {
      const res = await fetch(`${API_BASE}/api/login`, {
        method: 'POST',
        credentials: 'include',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ username, password })
      });
      if (!res.ok) throw await res.json();
      return await res.json();
    }
    async function checkMe() {
      try {
        const res = await fetch(`${API_BASE}/api/me`, { credentials: 'include' });
        if (!res.ok) return null;
        return await res.json();
      } catch (e) {
        return null;
      }
    }
    async function logoutFromServer() {
      try { await fetch(`${API_BASE}/api/logout`, { method: 'POST', credentials: 'include' }); } catch(e){/*ignore*/ }
    }

    // --------- Simple 3D animation (safe) ----------
    // Expose init3D/animate3D on window so debug & external calls work
    let scene, camera, renderer, particles = [], particleGeo, particleMat, animId;
    const PARTICLE_COUNT = 1200;
    function init3D() {
      try {
        // remove existing renderer if any
        const existing = document.querySelector('#sphere-container canvas');
        if (existing) existing.remove();

        // Basic three.js scene
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.z = 12;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
        const container = document.getElementById('sphere-container');
        container.appendChild(renderer.domElement);

        // Particles group
        particleGeo = new THREE.BufferGeometry();
        const positions = new Float32Array(PARTICLE_COUNT * 3);
        const colors = new Float32Array(PARTICLE_COUNT * 3);
        const sizes = new Float32Array(PARTICLE_COUNT);

        for (let i=0;i<PARTICLE_COUNT;i++){
          const phi = Math.acos(2*Math.random()-1);
          const theta = 2*Math.PI*Math.random();
          const r = 2.0 + Math.random()*4.2;
          const x = r * Math.sin(phi)*Math.cos(theta);
          const y = r * Math.sin(phi)*Math.sin(theta);
          const z = r * Math.cos(phi);
          positions[i*3] = x;
          positions[i*3+1] = y;
          positions[i*3+2] = z;
          const c = 0.6 + Math.random()*0.4;
          colors[i*3] = 0.0*c; colors[i*3+1] = 1.0*c; colors[i*3+2] = 0.6*c;
          sizes[i] = 1 + Math.random()*2.2;
        }
        particleGeo.setAttribute('position', new THREE.BufferAttribute(positions,3));
        particleGeo.setAttribute('color', new THREE.BufferAttribute(colors,3));
        particleGeo.setAttribute('size', new THREE.BufferAttribute(sizes,1));

        particleMat = new THREE.PointsMaterial({
          size: 0.12,
          vertexColors: true,
          transparent: true,
          opacity: 0.9,
          depthWrite: false,
          blending: THREE.AdditiveBlending
        });

        const points = new THREE.Points(particleGeo, particleMat);
        scene.add(points);

        // soft ambient glow
        const light = new THREE.PointLight(0x66ff88, 0.6);
        camera.add(light);
        scene.add(camera);

        window.addEventListener('resize', onWindowResize);
        log('3D initialized');
      } catch (err) {
        console.error('init3D error', err);
        log('3D init failed: ' + (err.message || err));
      }
    }
    function animate3D() {
      try {
        if (!renderer) return;
        const t = performance.now() * 0.0002;
        // rotate whole scene slowly
        scene.rotation.y = t * 0.2;
        scene.rotation.x = Math.sin(t*0.15)*0.05;

        // subtle per-vertex motion
        const pos = particleGeo.attributes.position.array;
        for (let i=0;i<PARTICLE_COUNT;i++){
          const idx = i*3;
          pos[idx+0] += Math.sin(t + i)*0.0009;
          pos[idx+1] += Math.cos(t*0.7 + i)*0.0007;
        }
        particleGeo.attributes.position.needsUpdate = true;

        renderer.render(scene, camera);
        animId = requestAnimationFrame(animate3D);
      } catch (err) {
        console.error('animate3D error', err);
        log('3D animate failed: ' + (err.message || err));
      }
    }
    function onWindowResize(){
      if (!camera || !renderer) return;
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // --------- Boot sequence ----------
    const phases = [
      { title: 'PHASE 1: SYSTEM-KERNEL LADEN', logs:[{t:'Initialisiere Core-Module...',d:500},{t:'Initialisiere Grafikmodule...',d:500}],progress:30 },
      { title: 'PHASE 2: NETZWERK-PROTOKOLLE', logs:[{t:'Prüfe Netzwerk...',d:700},{t:'Sicherheits-Handshake OK',d:450}],progress:66 },
      { title: 'PHASE 3: KERNKOMPONENTEN STARTEN', logs:[{t:'Rendere Partikel-Matrix...',d:700},{t:'Boot abgeschlossen',d:600}],progress:100 }
    ];

    async function runBootSequence(){
      loadingLogEl.style.display='block';
      progressFill.style.width = '0%';
      log('Boot started');
      for (let p of phases){
        document.getElementById('loading-text').textContent = p.title;
        for (let li of p.logs){
          log(li.t);
          await new Promise(r => setTimeout(r, li.d));
        }
        progressFill.style.width = p.progress + '%';
        await new Promise(r => setTimeout(r, 350));
      }
      await new Promise(r => setTimeout(r, 700));
      document.getElementById('access-granted').style.display = 'block';
      await new Promise(r => setTimeout(r, 900));
      document.getElementById('loader').style.display = 'none';
      await showLoginScreen();
    }

    // --------- Login UI wiring ----------
    function setupLoginListeners(){
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      const loginBtn = document.getElementById('login-btn');
      const registerBtn = document.getElementById('register-btn');
      const loginMessage = document.getElementById('login-message');

      const showMessage = (msg, error=true)=>{
        loginMessage.textContent = msg;
        loginMessage.style.color = error ? '#ff6666' : '#66ff88';
      };

      async function doLogin(){
        const user = usernameInput.value.trim();
        const pass = passwordInput.value.trim();
        if (!user || !pass) return showMessage('Benutzer & Passwort benötigt');
        showMessage('...', false);
        try {
          await loginToServer(user, pass);
          currentUser = user;
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('desktop').style.display = 'block';
          showMessage('', false);
        } catch (err) {
          console.warn('login failed', err);
          showMessage(err?.error || 'Login fehlgeschlagen');
        }
      }
      loginBtn.addEventListener('click', doLogin);
      passwordInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') doLogin(); });

      registerBtn.addEventListener('click', async ()=>{
        const user = usernameInput.value.trim();
        const pass = passwordInput.value.trim();
        if (!user || !pass) return showMessage('Benutzer & Passwort benötigt');
        showMessage('Registriere...', false);
        try {
          await registerToServer(user, pass);
          currentUser = user;
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('desktop').style.display = 'block';
          showMessage('Registrierung ok', false);
        } catch (err) {
          console.warn('register failed', err);
          showMessage(err?.error || 'Registrierung fehlgeschlagen');
        }
      });
    }

    // Logout handler
    function handleLogout(){
      logoutFromServer();
      document.getElementById('desktop').style.display = 'none';
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
    }

    // attach icons
    document.getElementById('logout-icon').addEventListener('click', handleLogout);

    // --------- Auto-login check & showLoginScreen ----------
    let currentUser = null;
    async function showLoginScreen(){
      // attempt checkMe
      const me = await checkMe();
      if (me && me.username){
        currentUser = me.username;
        document.getElementById('desktop').style.display = 'block';
        document.getElementById('login-screen').style.display = 'none';
      } else {
        document.getElementById('login-screen').style.display = 'flex';
      }
    }

    // --------- Debug overlay (in-page) ----------
    function installDebug(){
      try {
        const dbg = document.getElementById('debug-overlay');
        dbg.style.display = 'block';
        dbg.innerHTML = '<b>DEBUG PANEL</b><div id="dbg-lines" style="margin-top:8px;max-height:32vh;overflow:auto"></div>';
        const dlines = document.getElementById('dbg-lines');
        function dbglog(t){ const e=document.createElement('div'); e.textContent = '['+new Date().toLocaleTimeString()+'] '+t; dlines.appendChild(e); dlines.scrollTop=dlines.scrollHeight; }
        window.addEventListener('error', ev => dbglog('ERROR: '+(ev.message||ev.error?.message)));
        window.addEventListener('unhandledrejection', ev => dbglog('UNHANDLED REJECTION: '+(ev.reason?.message||JSON.stringify(ev.reason))));
        dbglog('Debug overlay active');
      } catch(e){ console.warn('debug install err', e); }
    }

    // --------- initialize app ----------
    window.addEventListener('load', async ()=>{
      // ensure three exists
      if (!window.THREE) {
        // try dynamic load fallback (shouldn't happen because we loaded in head)
        try {
          await new Promise((res, rej) => {
            const s = document.createElement('script');
            s.src = 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
            s.onload = res; s.onerror = rej; document.head.appendChild(s);
          });
          log('three.js loaded (fallback)');
        } catch(e){
          log('three.js could not be loaded: ' + e.message);
        }
      }

      // init 3D & start animation
      init3D();
      animate3D();
      installDebug();
      setupLoginListeners();

      // run boot sequence (this will hide loader and show login/desktop)
      try {
        await runBootSequence();
      } catch (e) {
        console.error('Boot error', e);
        log('Boot crashed: ' + (e.message||e));
        // still try to show login
        document.getElementById('loader').style.display = 'none';
        await showLoginScreen();
      }
    });

    // Expose for debug & manual control
    window.init3D = init3D;
    window.animate3D = animate3D;
    window.__app = { registerToServer, loginToServer, checkMe, logoutFromServer };
  })();
  </script>
</body>
</html>
