<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KI-Chatbot mit Persönlichkeit</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .chat-container {
            width: 100%;
            max-width: 600px;
            height: 80vh;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background-color: #4CAF50;
            color: #ffffff;
            padding: 15px;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 500;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 75%;
            padding: 12px 18px;
            border-radius: 20px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .user-message {
            align-self: flex-end;
            background-color: #007bff;
            color: #ffffff;
            border-bottom-right-radius: 5px;
        }

        .bot-message {
            align-self: flex-start;
            background-color: #e0e0e0;
            color: #333;
            border-bottom-left-radius: 5px;
        }
        
        .bot-message.loading-spinner {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            min-width: 60px;
        }
        
        .dot {
            width: 8px;
            height: 8px;
            background-color: #888;
            border-radius: 50%;
            margin: 0 4px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        .chat-input {
            display: flex;
            padding: 15px;
            background-color: #f9f9f9;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 20px;
            font-size: 1rem;
            outline: none;
        }

        .chat-input button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            margin-left: 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        .chat-input button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            KI-Chatbot
        </div>
        <div class="chat-messages" id="messages">
            <div class="message bot-message">Hallo! Ich bin ein KI-Assistent. Frag mich alles.</div>
        </div>
        <div class="chat-input">
            <input type="text" id="userInput" placeholder="Schreibe eine Nachricht..." autofocus>
            <button id="sendBtn" onclick="sendMessage()">Senden</button>
        </div>
    </div>

    <!-- Markdown-Bibliothek für die korrekte Formatierung -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script>
        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        
        // Holt den API-Schlüssel aus den Umgebungsvariablen
        const apiKey = "DEIN_API_SCHLÜSSEL";

        // Initialisiere die Markdown-Bibliothek
        const md = new markdownit();

        // Funktion, die eine Nachricht im Chat anzeigt
        function displayMessage(message, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
            
            // Verwende innerHTML, um Markdown zu rendern
            if (sender === 'bot') {
                messageElement.innerHTML = md.render(message);
            } else {
                messageElement.textContent = message;
            }

            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Funktion zur Anzeige eines Lade-Spinners
        function displayLoading() {
            const loadingElement = document.createElement('div');
            loadingElement.id = 'loadingSpinner';
            loadingElement.classList.add('message', 'bot-message', 'loading-spinner');
            loadingElement.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
            messagesDiv.appendChild(loadingElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return loadingElement;
        }
        
        // Funktion, um den Spinner zu entfernen und durch Text zu ersetzen
        function hideLoading(spinnerElement, message) {
            // Verwende innerHTML, um die formatierte Antwort zu rendern
            spinnerElement.innerHTML = md.render(message);
            spinnerElement.classList.remove('loading-spinner');
            spinnerElement.id = '';
        }

        // Funktion zur Kommunikation mit der Gemini API
        async function getGeminiResponse(userMessage) {
            if (!apiKey || apiKey === "AIzaSyB-0z8e59quUM-EaRl0tGiK-5eVaSUq3dQ") {
                 throw new Error("API-Schlüssel fehlt. Bitte trage deinen Schlüssel in den Umgebungsvariablen ein.");
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userMessage }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "Du bist ein KI-Assistent, der von Google entwickelt wurde. Du bist hilfreich, freundlich, sachkundig und sprichst Deutsch. Antworte in einem professionellen, aber dennoch lockeren und verständlichen Ton. Verwende Markdown für Hervorhebungen wie **fett** und *kursiv*. Verwende auch einfache Listen, um Informationen klar zu strukturieren." }]
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API-Fehler: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    return text;
                } else {
                    return "Entschuldigung, ich konnte keine Antwort generieren.";
                }

            } catch (error) {
                console.error("Fehler beim API-Aufruf:", error);
                return "Entschuldigung, es gab einen Fehler. Bitte versuche es später noch einmal.";
            }
        }

        // Funktion, die eine Nachricht sendet
        async function sendMessage() {
            const message = userInput.value;
            if (message.trim() === '') {
                return;
            }

            // Deaktiviere das Eingabefeld und den Senden-Button während der Verarbeitung
            userInput.disabled = true;
            sendBtn.disabled = true;

            // Zeige die Nachricht des Benutzers an
            displayMessage(message, 'user');
            userInput.value = '';

            // Zeige den Lade-Spinner an
            const loadingSpinner = displayLoading();

            try {
                // Warte auf die Antwort der KI-API
                const botResponse = await getGeminiResponse(message);
                
                // Ersetze den Spinner durch die Antwort
                hideLoading(loadingSpinner, botResponse);
            } catch (error) {
                // Zeige eine Fehlermeldung, falls der API-Aufruf fehlschlägt
                hideLoading(loadingSpinner, "Entschuldigung, es gab einen Fehler.");
            } finally {
                // Re-aktiviere das Eingabefeld und den Senden-Button
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
            }
        }

        // Füge einen Event-Listener hinzu, um auf die Enter-Taste zu reagieren
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
